
{% extends 'base.html' %}

{% block title %}Admin Panel - GPT-Engineer{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Admin Panel</h1>
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Users</h5>
                            <h2>{{ stats.user_count }}</h2>
                        </div>
                        <i class="bi bi-people fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Projects</h5>
                            <h2>{{ stats.project_count }}</h2>
                        </div>
                        <i class="bi bi-folder2 fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Active Jobs</h5>
                            <h2>{{ stats.active_jobs }}</h2>
                        </div>
                        <i class="bi bi-lightning fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Disk Usage</h5>
                            <h2>{{ stats.disk_usage }} MB</h2>
                        </div>
                        <i class="bi bi-hdd fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">System Load</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6>CPU</h6>
                                <div class="progress">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ stats.system_load.cpu }}%" aria-valuenow="{{ stats.system_load.cpu }}" aria-valuemin="0" aria-valuemax="100">{{ stats.system_load.cpu }}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6>Memory</h6>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ stats.system_load.memory }}%" aria-valuenow="{{ stats.system_load.memory }}" aria-valuemin="0" aria-valuemax="100">{{ stats.system_load.memory }}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6>Disk</h6>
                                <div class="progress">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ stats.system_load.disk }}%" aria-valuenow="{{ stats.system_load.disk }}" aria-valuemin="0" aria-valuemax="100">{{ stats.system_load.disk }}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <form action="/admin/backup" method="post">
                                <button type="submit" class="btn btn-primary btn-block w-100 mb-3">
                                    <i class="bi bi-cloud-arrow-up"></i> Create Backup
                                </button>
                            </form>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-warning btn-block w-100 mb-3" data-bs-toggle="modal" data-bs-target="#clearCacheModal">
                                <i class="bi bi-trash"></i> Clear Cache
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <button class="btn btn-success btn-block w-100" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="bi bi-person-plus"></i> Add User
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-danger btn-block w-100" data-bs-toggle="modal" data-bs-target="#systemMaintenanceModal">
                                <i class="bi bi-gear"></i> System Maintenance
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
                <i class="bi bi-people"></i> Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects" type="button" role="tab" aria-controls="projects" aria-selected="false">
                <i class="bi bi-folder2"></i> Projects
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button" role="tab" aria-controls="jobs" aria-selected="false">
                <i class="bi bi-clock-history"></i> Job History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">
                <i class="bi bi-journal-text"></i> System Logs
            </button>
        </li>
    </ul>
    
    <div class="tab-content mt-3" id="adminTabsContent">
        <!-- Users Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
            <div class="card shadow">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                    <tr>
                                        <td>{{ user.id }}</td>
                                        <td>{{ user.username }}</td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                                        <td>
                                            {% if user.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.is_admin %}
                                                <span class="badge bg-danger">Admin</span>
                                            {% else %}
                                                <span class="badge bg-secondary">User</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteUserModal{{ user.id }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    
<!-- Delete User Modal -->
                                    <div class="modal fade" id="deleteUserModal{{ user.id }}" tabindex="-1" aria-labelledby="deleteUserModalLabel{{ user.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="deleteUserModalLabel{{ user.id }}">Delete User</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="alert alert-danger">
                                                        <i class="bi bi-exclamation-triangle"></i> Warning: This action cannot be undone!
                                                    </div>
                                                    <p>Are you sure you want to delete the user "{{ user.username }}"?</p>
                                                    <p>This will also delete all projects owned by this user.</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <form action="{{ url_for('admin_delete_user', user_id=user.id) }}" method="post">
                                                        <button type="submit" class="btn btn-danger">Delete User</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Projects Tab -->
        <div class="tab-pane fade" id="projects" role="tabpanel" aria-labelledby="projects-tab">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Projects</h5>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Search projects..." id="projectSearchAdmin">
                        <button class="btn btn-outline-secondary" type="button" id="projectSearchBtn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="projectsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Owner</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Last Modified</th>
                                    <th>Model</th>
                                    <th>Public</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in projects %}
                                    <tr>
                                        <td>{{ project.id }}</td>
                                        <td>
                                            <a href="{{ url_for('project_detail', project_id=project.id) }}" class="fw-bold text-decoration-none">
                                                {{ project.name }}
                                            </a>
                                        </td>
                                        <td>
                                            {% if project.user_id %}
                                                {% for user in users %}
                                                    {% if user.id == project.user_id %}
                                                        {{ user.username }}
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if project.status == 'running' %}
                                                <span class="badge bg-info">Running</span>
                                            {% elif project.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif project.status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Idle</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ project.created_at.strftime('%Y-%m-%d %H:%M') if project.created_at else 'N/A' }}</td>
                                        <td>{{ project.last_modified.strftime('%Y-%m-%d %H:%M') if project.last_modified else 'N/A' }}</td>
                                        <td>{{ project.model }}</td>
                                        <td>
                                            {% if project.is_public %}
                                                <span class="badge bg-success">Public</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Private</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-warning toggle-public" data-project-id="{{ project.id }}" data-is-public="{{ 'true' if project.is_public else 'false' }}">
                                                    <i class="bi bi-{% if project.is_public %}lock-fill{% else %}unlock-fill{% endif %}"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal{{ project.id }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Delete Project Modal -->
                                    <div class="modal fade" id="deleteProjectModal{{ project.id }}" tabindex="-1" aria-labelledby="deleteProjectModalLabel{{ project.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="deleteProjectModalLabel{{ project.id }}">Delete Project</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="alert alert-danger">
                                                        <i class="bi bi-exclamation-triangle"></i> Warning: This action cannot be undone!
                                                    </div>
                                                    <p>Are you sure you want to delete the project "{{ project.name }}"?</p>
                                                    <p>This will permanently remove all code and history associated with this project.</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <form action="{{ url_for('delete_project', project_id=project.id) }}" method="post">
                                                        <button type="submit" class="btn btn-danger">Delete Project</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Jobs Tab -->
        <div class="tab-pane fade" id="jobs" role="tabpanel" aria-labelledby="jobs-tab">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Jobs</h5>
                    <div>
                        <select class="form-select form-select-sm" id="jobStatusFilter" style="width: 150px;">
                            <option value="all">All Statuses</option>
                            <option value="running">Running</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="jobsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Project</th>
                                    <th>Type</th>
                                    <th>Model</th>
                                    <th>Status</th>
                                    <th>Started</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in jobs %}
                                    <tr class="job-row" data-job-status="{{ job.status }}">
                                        <td>{{ job.id }}</td>
                                        <td>
                                            <a href="{{ url_for('project_detail', project_id=job.project_id) }}" class="fw-bold text-decoration-none">
                                                {{ job.project.name }}
                                            </a>
                                        </td>
                                        <td>
                                            {% if job.job_type == 'create' %}
                                                <span class="badge bg-primary">Create</span>
                                            {% else %}
                                                <span class="badge bg-success">Improve</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ job.model }}</td>
                                        <td>
                                            {% if job.status == 'running' %}
                                                <span class="badge bg-info">Running</span>
                                            {% elif job.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif job.status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ job.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ job.start_time.strftime('%Y-%m-%d %H:%M:%S') if job.start_time else 'N/A' }}</td>
                                        <td>
                                            {% if job.duration_seconds %}
                                                {{ (job.duration_seconds / 60)|round(1) }} minutes
                                            {% elif job.status == 'running' %}
                                                <span class="badge bg-info">In progress</span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-primary view-job-details" data-job-id="{{ job.id }}" data-bs-toggle="modal" data-bs-target="#jobDetailsModal{{ job.id }}">
                                                    <i class="bi bi-info-circle"></i>
                                                </button>
                                                {% if job.status == 'running' %}
                                                    <button type="button" class="btn btn-sm btn-danger cancel-job" data-job-id="{{ job.id }}">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Job Details Modal -->
                                    <div class="modal fade" id="jobDetailsModal{{ job.id }}" tabindex="-1" aria-labelledby="jobDetailsModalLabel{{ job.id }}" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="jobDetailsModalLabel{{ job.id }}">Job Details #{{ job.id }}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <h6>Project</h6>
                                                            <p>
                                                                <a href="{{ url_for('project_detail', project_id=job.project_id) }}">
                                                                    {{ job.project.name }}
                                                                </a>
                                                            </p>
                                                            
                                                            <h6>Job Type</h6>
                                                            <p>{{ job.job_type|capitalize }}</p>
                                                            
                                                            <h6>Model</h6>
                                                            <p>{{ job.model }}</p>
                                                            
                                                            <h6>Status</h6>
                                                            <p>
                                                                {% if job.status == 'running' %}
                                                                    <span class="badge bg-info">Running</span>
                                                                {% elif job.status == 'completed' %}
                                                                    <span class="badge bg-success">Completed</span>
                                                                {% elif job.status == 'failed' %}
                                                                    <span class="badge bg-danger">Failed</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">{{ job.status }}</span>
                                                                {% endif %}
                                                            </p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6>Started</h6>
                                                            <p>{{ job.start_time.strftime('%Y-%m-%d %H:%M:%S') if job.start_time else 'N/A' }}</p>
                                                            
                                                            <h6>Completed</h6>
                                                            <p>{{ job.end_time.strftime('%Y-%m-%d %H:%M:%S') if job.end_time else 'N/A' }}</p>
                                                            
                                                            <h6>Duration</h6>
                                                            <p>
                                                                {% if job.duration_seconds %}
                                                                    {{ (job.duration_seconds / 60)|round(1) }} minutes
                                                                {% else %}
                                                                    <span class="text-muted">N/A</span>
                                                                {% endif %}
                                                            </p>
                                                            
                                                            <h6>Files Changed</h6>
                                                            <p>{{ job.files_changed or 'N/A' }}</p>
                                                        </div>
                                                    </div>
                                                    
                                                    {% if job.prompt %}
                                                        <h6>Prompt</h6>
                                                        <div class="bg-light p-3 mb-3 rounded">
                                                            <pre class="mb-0">{{ job.prompt }}</pre>
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if job.error %}
                                                        <h6>Error</h6>
                                                        <div class="alert alert-danger">
                                                            <pre class="mb-0">{{ job.error }}</pre>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Logs Tab -->
        <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">System Logs</h5>
                    <div>
                        <select class="form-select form-select-sm" id="logLevelFilter" style="width: 150px;">
                            <option value="all">All Levels</option>
                            <option value="error">Errors</option>
                            <option value="warning">Warnings</option>
                            <option value="info">Info</option>
                            <option value="debug">Debug</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="log-container p-3 bg-dark text-light rounded" style="height: 500px; overflow-y: auto; font-family: monospace;">
                        <div id="logContent">
                            <!-- Log entries would be loaded dynamically via JavaScript -->
                            <div class="text-center p-5">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">Loading logs...</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-end mt-3">
                        <button class="btn btn-primary btn-sm" id="refreshLogs">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-danger btn-sm" id="clearLogs" data-bs-toggle="modal" data-bs-target="#clearLogsModal">
                            <i class="bi bi-trash"></i> Clear Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clear Cache Modal -->
<div class="modal fade" id="clearCacheModal" tabindex="-1" aria-labelledby="clearCacheModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearCacheModalLabel">Clear Cache</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to clear the application cache?</p>
                <p>This will remove temporary files and might affect currently running operations.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="/admin/clear_cache" method="post">
                    <button type="submit" class="btn btn-warning">Clear Cache</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm" action="/admin/users/add" method="post">
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="newUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="newEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="newPassword" name="password" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isAdmin" name="is_admin">
                        <label class="form-check-label" for="isAdmin">Administrator</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addUserForm" class="btn btn-success">Add User</button>
            </div>
        </div>
    </div>
</div>

<!-- System Maintenance Modal -->
<div class="modal fade" id="systemMaintenanceModal" tabindex="-1" aria-labelledby="systemMaintenanceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="systemMaintenanceModalLabel">System Maintenance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Warning: Some operations might affect running tasks!
                </div>
                <div class="d-grid gap-2">
                    <form action="/admin/restart_server" method="post">
                        <button type="submit" class="btn btn-warning btn-block w-100 mb-2">
                            <i class="bi bi-arrow-repeat"></i> Restart Application Server
                        </button>
                    </form>
                    <form action="/admin/cleanup_orphaned" method="post">
                        <button type="submit" class="btn btn-info btn-block w-100 mb-2">
                            <i class="bi bi-trash"></i> Clean Up Orphaned Files
                        </button>
                    </form>
                    <form action="/admin/optimize_db" method="post">
                        <button type="submit" class="btn btn-primary btn-block w-100 mb-2">
                            <i class="bi bi-speedometer"></i> Optimize Database
                        </button>
                    </form>
                    <form action="/admin/update_models" method="post">
                        <button type="submit" class="btn btn-success btn-block w-100">
                            <i class="bi bi-cloud-download"></i> Update Model Configurations
                        </button>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Logs Modal -->
<div class="modal fade" id="clearLogsModal" tabindex="-1" aria-labelledby="clearLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearLogsModalLabel">Clear System Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Warning: This will permanently delete all log files!
                </div>
                <p>Are you sure you want to clear all system logs? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="/admin/clear_logs" method="post">
                    <button type="submit" class="btn btn-danger">Clear All Logs</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize DataTables for better table functionality
    $(document).ready(function() {
        $('#usersTable').DataTable({
            order: [[0, 'desc']],
            pageLength: 10
        });
        
        $('#projectsTable').DataTable({
            order: [[0, 'desc']],
            pageLength: 10
        });
        
        $('#jobsTable').DataTable({
            order: [[0, 'desc']],
            pageLength: 15
        });
    });
    
    // Job status filter
    document.getElementById('jobStatusFilter').addEventListener('change', function() {
        const status = this.value;
        const rows = document.querySelectorAll('.job-row');
        
        rows.forEach(row => {
            if (status === 'all' || row.dataset.jobStatus === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Toggle project public/private status
    document.querySelectorAll('.toggle-public').forEach(button => {
        button.addEventListener('click', function() {
            const projectId = this.dataset.projectId;
            const isPublic = this.dataset.isPublic === 'true';
            
            fetch(`/api/projects/${projectId}/toggle_public`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ is_public: !isPublic })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the button icon and data attribute
                    const icon = this.querySelector('i');
                    if (isPublic) {
                        icon.classList.remove('bi-unlock-fill');
                        icon.classList.add('bi-lock-fill');
                        this.dataset.isPublic = 'false';
                    } else {
                        icon.classList.remove('bi-lock-fill');
                        icon.classList.add('bi-unlock-fill');
                        this.dataset.isPublic = 'true';
                    }
                    
                    // Show a success message
                    alert('Project visibility updated successfully');
                } else {
                    alert('Error updating project visibility: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating project visibility');
            });
        });
    });
    
    // Cancel running job
    document.querySelectorAll('.cancel-job').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this job? This might corrupt the project.')) {
                const jobId = this.dataset.jobId;
                
                fetch(`/api/jobs/${jobId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Job cancelled successfully');
                        location.reload();
                    } else {
                        alert('Error cancelling job: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while cancelling the job');
                });
            }
        });
    });
    
    // Log tab functionality
    document.getElementById('logs-tab').addEventListener('click', function() {
        loadLogs();
    });
    
    document.getElementById('refreshLogs').addEventListener('click', function() {
        loadLogs();
    });
    
    document.getElementById('logLevelFilter').addEventListener('change', function() {
        loadLogs(this.value);
    });
    
    function loadLogs(level = 'all') {
        const logContent = document.getElementById('logContent');
        logContent.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading logs...</p>
            </div>
        `;
        
        fetch(`/admin/logs?level=${level}`)
            .then(response => response.json())
            .then(data => {
                if (data.logs && data.logs.length > 0) {
                    logContent.innerHTML = '';
                    data.logs.forEach(log => {
                        const logClass = getLogLevelClass(log.level);
                        const logElement = document.createElement('div');
                        logElement.className = `log-entry ${logClass}`;
                        logElement.innerHTML = `<span class="log-timestamp">${log.timestamp}</span> <span class="log-level">[${log.level}]</span> ${log.message}`;
                        logContent.appendChild(logElement);
                    });
                    
                    // Scroll to the bottom
                    const logContainer = document.querySelector('.log-container');
                    logContainer.scrollTop = logContainer.scrollHeight;
                } else {
                    logContent.innerHTML = '<div class="text-center p-5">No logs found</div>';
                }
            })
            .catch(error => {
                console.error('Error loading logs:', error);
                logContent.innerHTML = '<div class="text-center p-5 text-danger">Error loading logs</div>';
            });
    }
    
    function getLogLevelClass(level) {
        switch(level.toLowerCase()) {
            case 'error':
                return 'text-danger';
            case 'warning':
                return 'text-warning';
            case 'info':
                return 'text-info';
            case 'debug':
                return 'text-secondary';
            default:
                return '';
        }
    }
    
    // Project search in admin
    document.getElementById('projectSearchBtn').addEventListener('click', function() {
        const searchTerm = document.getElementById('projectSearchAdmin').value.toLowerCase();
        const table = $('#projectsTable').DataTable();
        table.search(searchTerm).draw();
    });
    
    // Search on enter key
    document.getElementById('projectSearchAdmin').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('projectSearchBtn').click();
        }
    });
    
    // System monitoring refresh
    function refreshSystemStats() {
        fetch('/api/admin/system_stats')
            .then(response => response.json())
            .then(data => {
                // Update CPU progress bar
                const cpuBar = document.querySelector('.progress-bar[aria-valuenow]');
                cpuBar.style.width = data.system_load.cpu + '%';
                cpuBar.setAttribute('aria-valuenow', data.system_load.cpu);
                cpuBar.textContent = data.system_load.cpu + '%';
                
                // Update Memory progress bar
                const memBar = document.querySelectorAll('.progress-bar[aria-valuenow]')[1];
                memBar.style.width = data.system_load.memory + '%';
                memBar.setAttribute('aria-valuenow', data.system_load.memory);
                memBar.textContent = data.system_load.memory + '%';
                
                // Update Disk progress bar
                const diskBar = document.querySelectorAll('.progress-bar[aria-valuenow]')[2];
                diskBar.style.width = data.system_load.disk + '%';
                diskBar.setAttribute('aria-valuenow', data.system_load.disk);
                diskBar.textContent = data.system_load.disk + '%';
                
                // Update stat cards
                document.querySelector('.card.bg-primary h2').textContent = data.user_count;
                document.querySelector('.card.bg-success h2').textContent = data.project_count;
                document.querySelector('.card.bg-info h2').textContent = data.active_jobs;
                document.querySelector('.card.bg-warning h2').textContent = data.disk_usage + ' MB';
            })
            .catch(error => console.error('Error refreshing system stats:', error));
    }
    
    // Refresh system stats every 30 seconds
    setInterval(refreshSystemStats, 30000);
    
    // Check for active jobs and update their status
    function checkActiveJobs() {
        const runningJobs = document.querySelectorAll('.job-row[data-job-status="running"]');
        if (runningJobs.length > 0) {
            const jobIds = Array.from(runningJobs).map(job => job.querySelector('td:first-child').textContent);
            
            fetch('/api/admin/job_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ job_ids: jobIds })
            })
            .then(response => response.json())
            .then(data => {
                for (const [jobId, status] of Object.entries(data.statuses)) {
                    const jobRow = document.querySelector(`.job-row td:first-child:contains('${jobId}')`).closest('.job-row');
                    
                    if (jobRow && status !== 'running') {
                        // Job status has changed, refresh the page
                        location.reload();
                        break;
                    }
                }
            })
            .catch(error => console.error('Error checking job status:', error));
        }
    }
    
    // Check active jobs every 10 seconds
    if (document.querySelectorAll('.job-row[data-job-status="running"]').length > 0) {
        setInterval(checkActiveJobs, 10000);
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
});
</script>
{% endblock %}